<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Code Battle AI</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon/fonts/remixicon.css">
<style>
body{font-family:'Poppins',sans-serif;background:#0d1b2a;color:#fff;margin:0;padding:0;display:flex;flex-direction:column;align-items:center;min-height:100vh}
header{background:linear-gradient(90deg,#7b2ff7,#f107a3);width:100%;padding:15px;text-align:center;font-size:24px;font-weight:600}
#chat-container{width:90%;max-width:900px;flex:1;display:flex;flex-direction:column;margin-top:20px}
.message{background:#1b263b;border-radius:15px;padding:15px;margin:10px;max-width:70%;position:relative;word-wrap:break-word;white-space:pre-wrap}
.user{align-self:flex-end;background:#4e9af1}
.ai{align-self:flex-start}
#input-area{display:flex;width:90%;max-width:900px;margin:20px auto}
#question{flex:1;padding:12px;border:none;border-radius:10px;outline:none;font-size:16px}
#send{background:#7b2ff7;color:white;border:none;padding:12px 20px;border-radius:10px;cursor:pointer;font-size:16px}
.icon-btn{position:absolute;top:10px;font-size:18px;color:#aaa;cursor:pointer;transition:0.3s}
.icon-btn:hover{color:#fff}
.info-icon{left:-35px}
.refresh-icon{right:-35px}
#metadata-modal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#1b263b;padding:20px;border-radius:12px;display:none;z-index:10;width:300px;box-shadow:0 0 20px rgba(0,0,0,0.5)}
#metadata-modal p{margin:8px 0}
#metadata-modal button{background:#7b2ff7;border:none;padding:8px 12px;color:white;border-radius:8px;margin-top:10px;cursor:pointer}
</style>
</head>
<body>
<header>⚔️ Code Battle AI</header>
<div id="chat-container"></div>
<div id="input-area">
  <input type="text" id="question" placeholder="Ask me anything...">
  <button id="send">➤</button>
</div>

<div id="metadata-modal">
  <h3>Response Info</h3>
  <p id="meta-model"></p>
  <p id="meta-tokens"></p>
  <p id="meta-time"></p>
  <p id="meta-date"></p>
  <button onclick="closeMetadata()">Close</button>
</div>

<script>
const chatContainer=document.getElementById('chat-container');
const questionInput=document.getElementById('question');
const sendBtn=document.getElementById('send');
let lastMetadata={};

sendBtn.onclick=async()=>{await sendMessage();};
questionInput.addEventListener('keypress',e=>{if(e.key==="Enter")sendMessage();});

async function sendMessage(forceNew=false){
  const text=questionInput.value.trim();
  if(!text)return;
  appendMessage(text,'user');
  questionInput.value='';
  const aiMessage=appendMessage('Thinking...','ai');
  const res=await fetch('/ask',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({question:text,force_new:forceNew})});
  const data=await res.json();
  aiMessage.querySelector('.message-text').textContent=data.answer;
  addIcons(aiMessage,data,text);
}

function appendMessage(content,role){
  const div=document.createElement('div');
  div.className=`message ${role}`;
  const textDiv=document.createElement('div');
  textDiv.className='message-text';
  textDiv.style.whiteSpace='pre-wrap';
  textDiv.textContent=content;
  div.appendChild(textDiv);
  chatContainer.appendChild(div);
  chatContainer.scrollTop=chatContainer.scrollHeight;
  return div;
}

function addIcons(messageDiv,metadata,question){
  const info=document.createElement('i');
  info.className='ri-information-line icon-btn info-icon';
  info.onclick=()=>showMetadata(metadata);

  const refresh=document.createElement('i');
  refresh.className='ri-refresh-line icon-btn refresh-icon';
  refresh.onclick=()=>regenerateAnswer(messageDiv,question);

  messageDiv.appendChild(info);
  messageDiv.appendChild(refresh);
  lastMetadata=metadata;
}

function showMetadata(meta){
  document.getElementById('meta-model').textContent=`Model: ${meta.model}`;
  document.getElementById('meta-tokens').textContent=`Tokens: ${meta.tokens}`;
  document.getElementById('meta-time').textContent=`Response Time: ${meta.time}s`;
  document.getElementById('meta-date').textContent=`Generated: ${meta.timestamp}`;
  document.getElementById('metadata-modal').style.display='block';
}

function closeMetadata(){document.getElementById('metadata-modal').style.display='none';}

async function regenerateAnswer(oldDiv,question){
  oldDiv.querySelector('.message-text').textContent='Regenerating...';
  const res=await fetch('/ask',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({question:question,force_new:true})});
  const data=await res.json();
  oldDiv.querySelector('.message-text').textContent=data.answer;
  addIcons(oldDiv,data,question);
}
</script>
</body>
</html>
